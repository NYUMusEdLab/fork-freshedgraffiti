<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
  <title>Graffiti</title>
	<style>
		canvas {
			border: solid 1px #000;
		}
	</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/p5.min.js"></script>
  <script>
	var currStroke;
	var strokeHistory = [];
	var isDrawing;
	var strokeStart;
	
	var isRedrawing;
	var redrawStart;
	var redrawDuration = 5.0;
	var redrawMode = "duration";
	
  function setup() {
    createCanvas(640, 480);
		
		strokeWeight(10);
  }

  function draw() {
    if (isDrawing) {
			// Set up vectors
			if(currStroke.length > 0) {
				var oldPos = currStroke[currStroke.length - 1];
			} else {
				oldPos = createVector(mouseX, mouseY);
			}
			
			var newPos = createVector(mouseX, mouseY);
			
			line(oldPos.x, oldPos.y, newPos.x, newPos.y);
			
			currStroke.push(newPos);
    } else if(isRedrawing) {
			background(255);
			var index = frameCount - redrawStart;
			
			var percent = min(index / (redrawDuration * 30), 1);
			
			if(redrawMode == 'duration') {
				//If we redraw everything for the same duration
				for(var i = 0; i < strokeHistory.length; ++i) {
					drawPartialStroke(strokeHistory[i], percent);
				}
			} else if(redrawMode == 'speed_start') {
				// If we redraw everything with the same speed
				var longestStroke = 0;
				
				for(var i = 0; i < strokeHistory.length; ++i) {
					longestStroke = max(longestStroke, strokeHistory[i].length);
				}
				
				for(var i = 0; i < strokeHistory.length; ++i) {
					drawPartialStroke(strokeHistory[i], min(percent * (longestStroke / strokeHistory[i].length), 1));
				}
			} else if(redrawMode == 'speed_end') {
				// If we redraw everything with the same speed
				var longestStroke = 0;
				
				for(var i = 0; i < strokeHistory.length; ++i) {
					longestStroke = max(longestStroke, strokeHistory[i].length);
				}
				
				for(var i = 0; i < strokeHistory.length; ++i) {
					drawPartialStroke(strokeHistory[i], max((percent * longestStroke / strokeHistory[i].length) - (longestStroke / strokeHistory[i].length - 1), 0));
				}
			}
			
			if(percent >= 1) {
				isRedrawing = false;
			}
		}
  }
	
	function drawPartialStroke(stroke, percentage) {
		// Don't draw partial stroke
		if(stroke.length == 0) {
			return;
		}
		
		var strokeLength = stroke.length * percentage;
		var numSegments = floor(strokeLength);
		var extra = strokeLength - numSegments;
		
		var i = 0;
		
		for(i = 0; (i < numSegments + 1) && (i < stroke.length); ++i) {
			var oldPos = (i == 0) ? stroke[0] : stroke[i - 1];
			var newPos = stroke[i];
			
			if(i < numSegments) {
				line(oldPos.x, oldPos.y, newPos.x, newPos.y);
			} else {
				var midPos = p5.Vector.lerp(oldPos, newPos, extra);
				
				line(oldPos.x, oldPos.y, midPos.x, midPos.y);
			}
		}
	}
	
	// Interaction Stuff
	function mousePressed() {
		currStroke = new Array();
		isDrawing = true;
		isRedrawing = false;
		
		strokeStart = frameCount;
	}
	
	function mouseReleased() {
		strokeHistory.push(currStroke);
		isDrawing = false;
	}
	
	function keyReleased() {
		if( keyCode === ENTER ) {
			isRedrawing = true;
			redrawStart = frameCount;
		} else if( keyCode === BACKSPACE ) {
			isRedrawing = false;
			isDrawing = false;
			
			strokeHistory = [];
			background(255);
		}
	}
	
	function changeTime(evt) {
		document.getElementById('time_value').innerHTML = evt.target.value + ' s';
		redrawDuration = evt.target.value;
	}
	
	function changeMode(evt) {
		redrawMode = evt.target.value;
	}
  </script>
</head>

<body id="home">
<p>Click and drag to draw. Press enter to play from beginning. Press backspace/delete to clear the drawing.</p>
<form>
	<label id="time_label" for="time">Playback Time:</label><br/>
	<input type="range" oninput="changeTime(event);" step="0.1" name="time" min="0" max="10"><span id="time_value">5 s</span><br/>
	<label id="mode_label" for="mode">Playback Mode:</label><br/>
	<select name="mode" onchange="changeMode(event);">
		<option value="duration">Same Duration</option>
		<option value="speed_start">Same Speed (Synced Start)</option>
		<option value="speed_end">Same Speed (Synced End)</option>
	</select><br/><br/>
</form>
</body>
</html>