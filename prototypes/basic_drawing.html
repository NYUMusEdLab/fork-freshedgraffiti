<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
  <title>Graffiti</title>
	<style>
		canvas {
			border: solid 1px #000;
		}
	</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/p5.min.js"></script>
  <script>
	var brushDist = 5;
	
	var currStroke;
	var strokeHistory = [];
	var isDrawing;
	var strokeStart;
	
	var isRedrawing;
	var redrawStart;
	
  function setup() {
    createCanvas(640, 480);
		
		strokeWeight(10);
		//fill(0);
		//noStroke();
  }

  function draw() {
    if (isDrawing) {
			// Set up vectors
			if(currStroke.length > 0) {
				var oldPos = currStroke[currStroke.length - 1];
			} else {
				oldPos = createVector(mouseX, mouseY);
			}
			
			var newPos = createVector(mouseX, mouseY);
			
			line(oldPos.x, oldPos.y, newPos.x, newPos.y);
			
			currStroke.push(newPos);
    } else if(isRedrawing) {
			background(255);
			var index = frameCount - redrawStart;
			
			//If we redraw everything for the same duration
			var percent = min(index / 1000, 1);
			
			for(var i = 0; i < strokeHistory.length; ++i) {
				drawPartialStroke(strokeHistory[i], percent);
			}
			
			// If we redraw everything with the same speed
			// var percent = min(index / 60, 1);
			// 
			// var longestStroke = 0;
			// 
			// for(var i = 0; i < strokeHistory.length; ++i) {
			// 	longestStroke = max(longestStroke, strokeHistory[i].length);
			// }
			// 
			// for(var i = 0; i < strokeHistory.length; ++i) {
			// 	drawPartialStroke(strokeHistory[i], min(percent * (longestStroke / strokeHistory[i].length), 1));
			// }
			
			if(percent >= 1) {
				isRedrawing = false;
			}
		}
  }
	
	function drawPartialStroke(stroke, percentage) {
		// Don't draw partial stroke
		if(stroke.length == 0) {
			return;
		}
		
		var strokeLength = stroke.length * percentage;
		var numSegments = floor(strokeLength);
		var extra = strokeLength - numSegments;
		
		var i = 0;
		
		for(i = 0; (i < numSegments + 1) && (i < stroke.length); ++i) {
			var oldPos = (i == 0) ? stroke[0] : stroke[i - 1];
			var newPos = stroke[i];
			
			if(i < numSegments) {
				line(oldPos.x, oldPos.y, newPos.x, newPos.y);
			} else {
				var midPos = p5.Vector.lerp(oldPos, newPos, extra);
				
				line(oldPos.x, oldPos.y, midPos.x, midPos.y);
			}
		}
	}
	
	// Interaction Stuff
	function mousePressed() {
		currStroke = new Array();
		isDrawing = true;
		isRedrawing = false;
		
		strokeStart = frameCount;
	}
	
	function mouseReleased() {
		strokeHistory.push(currStroke);
		isDrawing = false;
	}
	
	function keyReleased() {
		if( keyCode === ENTER ) {
			isRedrawing = true;
			redrawStart = frameCount;
		} else if( keyCode === BACKSPACE ) {
			isRedrawing = false;
			isDrawing = false;
			
			strokeHistory = [];
			background(255);
		}
	}
  </script>
</head>

<body id="home">
<p>click and drag to draw. Press enter to play from beginning.</p>
</body>
</html>